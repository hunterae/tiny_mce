(function(){var o=tinymce.util.JSONRequest,l=tinymce.each,p=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion}},init:function(b,c){var a=this;a.url=c;a.editor=b;a.rpcUrl=b.getParam("spellchecker_rpc_url","{backend}");if(a.rpcUrl=="{backend}"){if(tinymce.isIE)return;
a.hasSupport=true;b.onContextMenu.addToTop(function(){if(a.active)return false})}b.addCommand("mceSpellCheck",function(){if(a.rpcUrl=="{backend}")a.editor.getBody().spellcheck=a.active=!a.active;else if(a.active)a._done();else{b.setProgressState(1);a._sendRPC("checkWords",[a.selectedLang,a._getWords()],function(d){if(d.length>0){a.active=1;a._markWords(d);b.setProgressState(0);b.nodeChanged()}else{b.setProgressState(0);b.getParam("spellchecker_report_no_misspellings",true)&&b.windowManager.alert("spellchecker.no_mpell")}})}});
b.onInit.add(function(){b.settings.content_css!==false&&b.dom.loadCSS(c+"/css/content.css")});b.onClick.add(a._showMenu,a);b.onContextMenu.add(a._showMenu,a);b.onBeforeGetContent.add(function(){a.active&&a._removeWords()});b.onNodeChange.add(function(d,e){e.setActive("spellchecker",a.active)});b.onSetContent.add(function(){a._done()});b.onBeforeGetContent.add(function(){a._done()});b.onBeforeExecCommand.add(function(d,e){e=="mceFullScreen"&&a._done()});a.languages={};l(b.getParam("spellchecker_languages",
"+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(d,e){if(e.indexOf("+")===0){e=e.substring(1);a.selectedLang=d}a.languages[e]=d})},createControl:function(b,c){var a=this,d;if(b=="spellchecker"){if(a.rpcUrl=="{backend}"){if(a.hasSupport)d=c.createButton(b,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:a});return d}d=c.createSplitButton(b,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:a});d.onRenderMenu.add(function(e,
f){f.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1);l(a.languages,function(h,k){var i={icon:1},g;i.onclick=function(){g.setSelected(1);a.selectedItem.setSelected(0);a.selectedItem=g;a.selectedLang=h};i.title=k;g=f.add(i);g.setSelected(h==a.selectedLang);if(h==a.selectedLang)a.selectedItem=g})});return d}},_walk:function(b,c){var a=this.editor.getDoc();if(a.createTreeWalker)for(a=a.createTreeWalker(b,NodeFilter.SHOW_TEXT,null,false);(b=a.nextNode())!=null;)c.call(this,
b);else tinymce.walk(b,c,"childNodes")},_getSeparators:function(){var b="",c,a=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\u201d\u201c');for(c=0;c<a.length;c++)b+="\\"+a.charAt(c);return b},_getWords:function(){var b=this.editor,c=[],a="",d={},e=[];this._walk(b.getBody(),function(f){if(f.nodeType==3)a+=f.nodeValue+" "});if(b.getParam("spellchecker_word_pattern"))e=
a.match("("+b.getParam("spellchecker_word_pattern")+")","gi");else{a=a.replace(RegExp("([0-9]|["+this._getSeparators()+"])","g")," ");a=tinymce.trim(a.replace(/(\s+)/g," "));e=a.split(" ")}l(e,function(f){if(!d[f]){c.push(f);d[f]=1}});return c},_removeWords:function(b){var c=this.editor,a=c.dom;c=c.selection;var d=c.getBookmark();l(a.select("span").reverse(),function(e){if(e&&(a.hasClass(e,"mceItemHiddenSpellWord")||a.hasClass(e,"mceItemHidden")))if(!b||a.decode(e.innerHTML)==b)a.remove(e,1)});c.moveToBookmark(d)},
_markWords:function(b){var c,a,d,e,f,h="",k=this.editor,i=this._getSeparators(),g=k.dom,n=[];k=k.selection;var q=k.getBookmark();l(b,function(m){h+=(h?"|":"")+m});c=RegExp("(["+i+"])("+h+")(["+i+"])","g");a=RegExp("^("+h+")","g");d=RegExp("("+h+")(["+i+"]?)$","g");e=RegExp("^("+h+")(["+i+"]?)$","g");f=RegExp("("+h+")(["+i+"])","g");this._walk(this.editor.getBody(),function(m){m.nodeType==3&&n.push(m)});l(n,function(m){var j;if(m.nodeType==3){j=m.nodeValue;if(c.test(j)||a.test(j)||d.test(j)||e.test(j)){j=
g.encode(j);j=j.replace(f,'<span class="mceItemHiddenSpellWord">$1</span>$2');j=j.replace(d,'<span class="mceItemHiddenSpellWord">$1</span>$2');g.replace(g.create("span",{"class":"mceItemHidden"},j),m)}}});k.moveToBookmark(q)},_showMenu:function(b,c){var a=this;b=a.editor;var d=a._menu,e,f=b.dom,h=f.getViewPort(b.getWin());if(!d){e=p.getPos(b.getContentAreaContainer());d=b.controlManager.createDropMenu("spellcheckermenu",{offset_x:e.x,offset_y:e.y,"class":"mceNoIcons"});a._menu=d}if(f.hasClass(c.target,
"mceItemHiddenSpellWord")){d.removeAll();d.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1);a._sendRPC("getSuggestions",[a.selectedLang,f.decode(c.target.innerHTML)],function(k){var i;d.removeAll();if(k.length>0){d.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1);l(k,function(g){d.add({title:g,onclick:function(){f.replace(b.getDoc().createTextNode(g),c.target);a._checkDone()}})});d.addSeparator()}else d.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1);
i=a.editor.getParam("spellchecker_enable_ignore_rpc","");d.add({title:"spellchecker.ignore_word",onclick:function(){var g=c.target.innerHTML;f.remove(c.target,1);a._checkDone();if(i){b.setProgressState(1);a._sendRPC("ignoreWord",[a.selectedLang,g],function(){b.setProgressState(0)})}}});d.add({title:"spellchecker.ignore_words",onclick:function(){var g=c.target.innerHTML;a._removeWords(f.decode(g));a._checkDone();if(i){b.setProgressState(1);a._sendRPC("ignoreWords",[a.selectedLang,g],function(){b.setProgressState(0)})}}});
a.editor.getParam("spellchecker_enable_learn_rpc")&&d.add({title:"spellchecker.learn_word",onclick:function(){var g=c.target.innerHTML;f.remove(c.target,1);a._checkDone();b.setProgressState(1);a._sendRPC("learnWord",[a.selectedLang,g],function(){b.setProgressState(0)})}});d.update()});b.selection.select(c.target);e=f.getPos(c.target);d.showMenu(e.x,e.y+c.target.offsetHeight-h.y);return tinymce.dom.Event.cancel(c)}else d.hideMenu()},_checkDone:function(){var b=this.editor.dom,c;l(b.select("span"),
function(a){if(a&&b.hasClass(a,"mceItemHiddenSpellWord")){c=true;return false}});c||this._done()},_done:function(){var b=this.active;if(this.active){this.active=0;this._removeWords();this._menu&&this._menu.hideMenu();b&&this.editor.nodeChanged()}},_sendRPC:function(b,c,a){var d=this;o.sendRPC({url:d.rpcUrl,method:b,params:c,success:a,error:function(e,f){d.editor.setProgressState(0);d.editor.windowManager.alert(e.errstr||"Error response: "+f.responseText)}})}});tinymce.PluginManager.add("spellchecker",
tinymce.plugins.SpellcheckerPlugin)})();
