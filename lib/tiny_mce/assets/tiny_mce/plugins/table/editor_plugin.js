(function(w){function J(p,n,D){function E(a,c){a=a.cloneNode(c);a.removeAttribute("id");return a}function C(){var a=0;k=[];q(["thead","tbody","tfoot"],function(c){var e=n.select(c+" tr",p);q(e,function(g,f){f+=a;q(n.select("td,th",g),function(d,h){var m,v,I,F;if(k[f])for(;k[f][h];)h++;I=b(d,"rowspan");F=b(d,"colspan");for(v=f;v<f+I;v++){k[v]||(k[v]=[]);for(m=h;m<h+F;m++)k[v][m]={part:c,real:v==f&&m==h,elm:d,rowspan:I,colspan:F}}})});a+=e.length})}function B(a,c){var e;if(e=k[c])return e[a]}function b(a,
c){return parseInt(a.getAttribute(c)||1)}function o(a){return n.hasClass(a.elm,"mceSelected")||a==G}function t(){var a=[];q(p.rows,function(c){q(c.cells,function(e){if(n.hasClass(e,"mceSelected")||e==G.elm){a.push(c);return false}})});return a}function u(a){var c;w.walk(a,function(e){var g;if(e.nodeType==3){q(n.getParents(e.parentNode,null,a).reverse(),function(f){f=E(f,false);if(c)g&&g.appendChild(f);else c=g=f;g=f});if(g)g.innerHTML=w.isIE?"&nbsp;":'<br _mce_bogus="1" />';return false}},"childNodes");
a=E(a,false);a.rowSpan=a.colSpan=1;if(c)a.appendChild(c);else if(!w.isIE)a.innerHTML='<br _mce_bogus="1" />';return a}function z(){var a=n.createRng();q(n.select("tr",p),function(c){c.cells.length==0&&n.remove(c)});if(n.select("tr",p).length==0){a.setStartAfter(p);a.setEndAfter(p);D.setRng(a);n.remove(p)}else{q(n.select("thead,tbody,tfoot",p),function(c){c.rows.length==0&&n.remove(c)});C();if(row=k[Math.min(k.length-1,s.y)]){D.select(row[Math.min(row.length-1,s.x)].elm,true);D.collapse(true)}}}function H(a,
c,e,g){var f,d,h,m,v;f=k[c][a].elm.parentNode;for(h=1;h<=e;h++)if(f=n.getNext(f,"tr")){for(d=a;d>=0;d--){v=k[c+h][d].elm;if(v.parentNode==f){for(m=1;m<=g;m++)n.insertAfter(u(v),v);break}}if(d==-1)for(m=1;m<=g;m++)f.insertBefore(u(f.cells[0]),f.cells[0])}}function r(){q(k,function(a,c){q(a,function(e,g){var f,d,h;if(o(e)){e=e.elm;f=b(e,"colspan");d=b(e,"rowspan");if(f>1||d>1){e.colSpan=e.rowSpan=1;for(h=0;h<f-1;h++)n.insertAfter(u(e),e);H(g,c,d-1,f)}}})})}function j(a){var c;q(k,function(e,g){q(e,
function(f,d){if(f.elm==a){c={x:d,y:g};return false}});return!c});return c}function l(){var a,c;a=c=0;q(k,function(e,g){q(e,function(f,d){var h,m;if(o(f)){f=k[g][d];if(d>a)a=d;if(g>c)c=g;if(f.real){h=f.colspan-1;m=f.rowspan-1;if(h)if(d+h>a)a=d+h;if(m)if(g+m>c)c=g+m}}})});return{x:a,y:c}}var k,s,A,G;C();if(G=n.getParent(D.getStart(),"th,td")){s=j(G);A=l();G=B(s.x,s.y)}w.extend(this,{deleteTable:function(){var a=n.createRng();a.setStartAfter(p);a.setEndAfter(p);D.setRng(a);n.remove(p)},split:r,merge:function(a,
c,e){var g,f,d,h,m;if(a){pos=j(a);g=pos.x;a=pos.y;c=g+(c-1);e=a+(e-1)}else{g=s.x;a=s.y;c=A.x;e=A.y}h=B(g,a);f=B(c,e);if(h&&f&&h.part==f.part){r();C();h=B(g,a).elm;h.colSpan=c-g+1;h.rowSpan=e-a+1;for(d=a;d<=e;d++)for(f=g;f<=c;f++){a=k[d][f].elm;if(a!=h){m=w.grep(a.childNodes);q(m,function(v,I){if(v.nodeName!="BR"||I!=m.length-1)h.appendChild(v)});n.remove(a)}}z()}},insertRow:function(a){var c,e,g,f,d,h,m;q(k,function(v,I){q(v,function(F){if(o(F)){F=F.elm;d=F.parentNode;h=E(d,false);c=I;if(a)return false}});
if(a)return!c});for(f=0;f<k[0].length;f++){e=k[c][f].elm;if(e!=g){if(a){if(c>0&&k[c-1][f]){m=k[c-1][f].elm;rowSpan=b(m,"rowspan");if(rowSpan>1){m.rowSpan=rowSpan+1;continue}}}else{rowSpan=b(e,"rowspan");if(rowSpan>1){e.rowSpan=rowSpan+1;continue}}g=u(e);g.colSpan=e.colSpan;h.appendChild(g);g=e}}if(h.hasChildNodes())a?d.parentNode.insertBefore(h,d):n.insertAfter(h,d)},insertCol:function(a){var c,e;q(k,function(g){q(g,function(f,d){if(o(f)){c=d;if(a)return false}});if(a)return!c});q(k,function(g,f){var d=
g[c].elm,h,m;if(d!=e){m=b(d,"colspan");h=b(d,"rowspan");if(m==1){a?d.parentNode.insertBefore(u(d),d):n.insertAfter(u(d),d);H(c,f,h-1,m)}else d.colSpan++;e=d}})},deleteCols:function(){var a=[];q(k,function(c){q(c,function(e,g){if(o(e)&&w.inArray(a,g)===-1){q(k,function(f){f=f[g].elm;var d;d=b(f,"colspan");if(d>1)f.colSpan=d-1;else n.remove(f)});a.push(g)}})});z()},deleteRows:function(){function a(e){var g,f;n.getNext(e,"tr");q(e.cells,function(d){var h=b(d,"rowspan");if(h>1){d.rowSpan=h-1;g=j(d);H(g.x,
g.y,1,1)}});g=j(e.cells[0]);q(k[g.y],function(d){var h;d=d.elm;if(d!=f){h=b(d,"rowspan");if(h<=1)n.remove(d);else d.rowSpan=h-1;f=d}})}var c;c=t();q(c.reverse(),function(e){a(e)});z()},cutRows:function(){var a=t();n.remove(a);z();return a},copyRows:function(){var a=t();q(a,function(c,e){a[e]=E(c,true)});return a},pasteRows:function(a,c){var e=t(),g=e[c?0:e.length-1],f=g.cells.length;q(k,function(d){var h;f=0;q(d,function(m){if(m.real)f+=m.colspan;if(m.elm.parentNode==g)h=1});if(h)return false});c||
a.reverse();q(a,function(d){var h=d.cells.length,m;for(i=0;i<h;i++){m=d.cells[i];m.colSpan=m.rowSpan=1}for(i=h;i<f;i++)d.appendChild(u(d.cells[h-1]));for(i=f;i<h;i++)n.remove(d.cells[i]);c?g.parentNode.insertBefore(d,g):n.insertAfter(d,g)})},getPos:j,setStartCell:function(a){s=j(a)},setEndCell:function(a){var c,e,g,f,d,h,m;A=j(a);if(s&&A){c=Math.min(s.x,A.x);e=Math.min(s.y,A.y);g=Math.max(s.x,A.x);f=Math.max(s.y,A.y);d=g;h=f;for(y=e;y<=h;y++){a=k[y][c];if(!a.real)if(c-(a.colspan-1)<c)c-=a.colspan-
1}for(x=c;x<=d;x++){a=k[e][x];if(!a.real)if(e-(a.rowspan-1)<e)e-=a.rowspan-1}for(y=e;y<=f;y++)for(x=c;x<=g;x++){a=k[y][x];if(a.real){m=a.colspan-1;a=a.rowspan-1;if(m)if(x+m>d)d=x+m;if(a)if(y+a>h)h=y+a}}n.removeClass(n.select("td.mceSelected,th.mceSelected"),"mceSelected");for(y=e;y<=h;y++)for(x=c;x<=d;x++)n.addClass(k[y][x].elm,"mceSelected")}}})}var q=w.each;w.create("tinymce.plugins.TablePlugin",{init:function(p,n){function D(b){var o=p.selection;if(b=p.dom.getParent(b||o.getNode(),"table"))return new J(b,
p.dom,o)}function E(){p.getBody().style.webkitUserSelect="";p.dom.removeClass(p.dom.select("td.mceSelected,th.mceSelected"),"mceSelected")}var C,B;q([["table","table.desc","mceInsertTable",true],["delete_table","table.del","mceTableDelete"],["delete_col","table.delete_col_desc","mceTableDeleteCol"],["delete_row","table.delete_row_desc","mceTableDeleteRow"],["col_after","table.col_after_desc","mceTableInsertColAfter"],["col_before","table.col_before_desc","mceTableInsertColBefore"],["row_after","table.row_after_desc",
"mceTableInsertRowAfter"],["row_before","table.row_before_desc","mceTableInsertRowBefore"],["row_props","table.row_desc","mceTableRowProps",true],["cell_props","table.cell_desc","mceTableCellProps",true],["split_cells","table.split_cells_desc","mceTableSplitCells",true],["merge_cells","table.merge_cells_desc","mceTableMergeCells",true]],function(b){p.addButton(b[0],{title:b[1],cmd:b[2],ui:b[3]})});w.isIE||p.onClick.add(function(b,o){o=o.target;o.nodeName==="TABLE"&&b.selection.select(o)});p.onNodeChange.add(function(b,
o,t){t=b.selection.getStart();b=b.dom.getParent(t,"td,th,caption");o.setActive("table",t.nodeName==="TABLE"||!!b);if(b&&b.nodeName==="CAPTION")b=0;o.setDisabled("delete_table",!b);o.setDisabled("delete_col",!b);o.setDisabled("delete_table",!b);o.setDisabled("delete_row",!b);o.setDisabled("col_after",!b);o.setDisabled("col_before",!b);o.setDisabled("row_after",!b);o.setDisabled("row_before",!b);o.setDisabled("row_props",!b);o.setDisabled("cell_props",!b);o.setDisabled("split_cells",!b);o.setDisabled("merge_cells",
!b)});p.onInit.add(function(b){var o,t,u=b.dom,z;C=b.windowManager;b.onMouseDown.add(function(r,j){if(j.button!=2){E();t=u.getParent(j.target,"td,th");o=u.getParent(t,"table")}});u.bind(b.getDoc(),"mouseover",function(r){var j,l=r.target;if(t&&(z||l!=t)&&(l.nodeName=="TD"||l.nodeName=="TH")){j=u.getParent(l,"table");if(j==o){if(!z){z=D(j);z.setStartCell(t);b.getBody().style.webkitUserSelect="none"}z.setEndCell(l)}j=b.selection.getSel();j.removeAllRanges?j.removeAllRanges():j.empty();r.preventDefault()}});
b.onMouseUp.add(function(r){var j,l=r.selection,k;l.getSel();var s,A;if(t){if(z)r.getBody().style.webkitUserSelect="";var G=function(a,c){var e=new w.dom.TreeWalker(a,a);do{if(a.nodeType==3&&w.trim(a.nodeValue).length!=0){c?j.setStart(a,0):j.setEnd(a,a.nodeValue.length);break}if(a.nodeName=="BR"){c?j.setStartBefore(a):j.setEndBefore(a);break}}while(a=c?e.next():e.prev())};k=u.select("td.mceSelected,th.mceSelected");if(k.length>0){j=u.createRng();s=k[0];G(s,1);k=new w.dom.TreeWalker(s,u.getParent(k[0],
"table"));do if(s.nodeName=="TD"||s.nodeName=="TH"){if(!u.hasClass(s,"mceSelected"))break;A=s}while(s=k.next());G(A);l.setRng(j)}r.nodeChanged();t=z=o=null}});b.onKeyUp.add(function(){E()});b&&b.plugins.contextmenu&&b.plugins.contextmenu.onContextMenu.add(function(r,j,l){r=b.selection.getNode()||b.getBody();if(b.dom.getParent(l,"td")||b.dom.getParent(l,"th")||b.dom.select("td.mceSelected,th.mceSelected").length){j.removeAll();if(r.nodeName=="A"&&!b.dom.getAttrib(r,"name")){j.add({title:"advanced.link_desc",
icon:"link",cmd:b.plugins.advlink?"mceAdvLink":"mceLink",ui:true});j.add({title:"advanced.unlink_desc",icon:"unlink",cmd:"UnLink"});j.addSeparator()}if(r.nodeName=="IMG"&&r.className.indexOf("mceItem")==-1){j.add({title:"advanced.image_desc",icon:"image",cmd:b.plugins.advimage?"mceAdvImage":"mceImage",ui:true});j.addSeparator()}j.add({title:"table.desc",icon:"table",cmd:"mceInsertTable",value:{action:"insert"}});j.add({title:"table.props_desc",icon:"table_props",cmd:"mceInsertTable"});j.add({title:"table.del",
icon:"delete_table",cmd:"mceTableDelete"});j.addSeparator();l=j.addMenu({title:"table.cell"});l.add({title:"table.cell_desc",icon:"cell_props",cmd:"mceTableCellProps"});l.add({title:"table.split_cells_desc",icon:"split_cells",cmd:"mceTableSplitCells"});l.add({title:"table.merge_cells_desc",icon:"merge_cells",cmd:"mceTableMergeCells"});l=j.addMenu({title:"table.row"});l.add({title:"table.row_desc",icon:"row_props",cmd:"mceTableRowProps"});l.add({title:"table.row_before_desc",icon:"row_before",cmd:"mceTableInsertRowBefore"});
l.add({title:"table.row_after_desc",icon:"row_after",cmd:"mceTableInsertRowAfter"});l.add({title:"table.delete_row_desc",icon:"delete_row",cmd:"mceTableDeleteRow"});l.addSeparator();l.add({title:"table.cut_row_desc",icon:"cut",cmd:"mceTableCutRow"});l.add({title:"table.copy_row_desc",icon:"copy",cmd:"mceTableCopyRow"});l.add({title:"table.paste_row_before_desc",icon:"paste",cmd:"mceTablePasteRowBefore"}).setDisabled(!B);l.add({title:"table.paste_row_after_desc",icon:"paste",cmd:"mceTablePasteRowAfter"}).setDisabled(!B);
l=j.addMenu({title:"table.col"});l.add({title:"table.col_before_desc",icon:"col_before",cmd:"mceTableInsertColBefore"});l.add({title:"table.col_after_desc",icon:"col_after",cmd:"mceTableInsertColAfter"});l.add({title:"table.delete_col_desc",icon:"delete_col",cmd:"mceTableDeleteCol"})}else j.add({title:"table.desc",icon:"table",cmd:"mceInsertTable"})});if(!w.isIE){var H=function(){var r;for(r=b.getBody().lastChild;r&&r.nodeType==3&&!r.nodeValue.length;r=r.previousSibling);r&&r.nodeName=="TABLE"&&b.dom.add(b.getBody(),
"p",null,'<br mce_bogus="1" />')};w.isGecko&&b.onKeyDown.add(function(r,j){var l,k,s=r.dom;if(j.keyCode==37||j.keyCode==38){l=r.selection.getRng();if((k=s.getParent(l.startContainer,"table"))&&r.getBody().firstChild==k)if(isAtStart(l,k)){l=s.createRng();l.setStartBefore(k);l.setEndBefore(k);r.selection.setRng(l);j.preventDefault()}}});b.onKeyUp.add(H);b.onSetContent.add(H);b.onVisualAid.add(H);b.onPreProcess.add(function(r,j){var l=j.node.lastChild;l&&l.childNodes.length==1&&l.firstChild.nodeName==
"BR"&&r.dom.remove(l)});H()}});q({mceTableSplitCells:function(b){b.split()},mceTableMergeCells:function(b){var o,t,u;if(u=p.dom.getParent(p.selection.getNode(),"th,td")){o=u.rowSpan;t=u.colSpan}p.dom.select("td.mceSelected,th.mceSelected").length?b.merge():C.open({url:n+"/merge_cells.htm",width:240+parseInt(p.getLang("table.merge_cells_delta_width",0)),height:110+parseInt(p.getLang("table.merge_cells_delta_height",0)),inline:1},{rows:o,cols:t,onaction:function(z){b.merge(u,z.cols,z.rows)},plugin_url:n})},
mceTableInsertRowBefore:function(b){b.insertRow(true)},mceTableInsertRowAfter:function(b){b.insertRow()},mceTableInsertColBefore:function(b){b.insertCol(true)},mceTableInsertColAfter:function(b){b.insertCol()},mceTableDeleteCol:function(b){b.deleteCols()},mceTableDeleteRow:function(b){b.deleteRows()},mceTableCutRow:function(b){B=b.cutRows()},mceTableCopyRow:function(b){B=b.copyRows()},mceTablePasteRowBefore:function(b){b.pasteRows(B,true)},mceTablePasteRowAfter:function(b){b.pasteRows(B)},mceTableDelete:function(b){b.deleteTable()}},
function(b,o){p.addCommand(o,function(){var t=D();if(t){b(t);p.execCommand("mceRepaint");E()}})});q({mceInsertTable:function(b){C.open({url:n+"/table.htm",width:400+parseInt(p.getLang("table.table_delta_width",0)),height:320+parseInt(p.getLang("table.table_delta_height",0)),inline:1},{plugin_url:n,action:b?b.action:0})},mceTableRowProps:function(){C.open({url:n+"/row.htm",width:400+parseInt(p.getLang("table.rowprops_delta_width",0)),height:295+parseInt(p.getLang("table.rowprops_delta_height",0)),
inline:1},{plugin_url:n})},mceTableCellProps:function(){C.open({url:n+"/cell.htm",width:400+parseInt(p.getLang("table.cellprops_delta_width",0)),height:295+parseInt(p.getLang("table.cellprops_delta_height",0)),inline:1},{plugin_url:n})}},function(b,o){p.addCommand(o,function(t,u){b(u)})})}});w.PluginManager.add("table",w.plugins.TablePlugin)})(tinymce);
