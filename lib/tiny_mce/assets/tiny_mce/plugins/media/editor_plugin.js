(function(){function B(a){var g,c;if(a&&!a.splice){g=[];for(c=0;;c++)if(a[c])g[c]=a[c];else break;return g}return a}var C=tinymce.makeMap("id,width,height,type"),s=tinymce.html.Node,y,z,w=tinymce.util.JSON;y=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],
["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],
["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Video"]];tinymce.create("tinymce.plugins.MediaPlugin",{init:function(a,g){function c(d){return d&&d.nodeName==="IMG"&&a.dom.hasClass(d,"mceItemMedia")}var e=this,i={},l,h,m,n;e.editor=a;e.url=g;z="";for(l=0;l<y.length;l++){n=y[l][0];m={name:n,clsids:tinymce.explode(y[l][1]||
""),mimes:tinymce.explode(y[l][2]||""),codebase:y[l][3]};for(h=0;h<m.clsids.length;h++)i["clsid:"+m.clsids[h]]=m;for(h=0;h<m.mimes.length;h++)i[m.mimes[h]]=m;i["mceItem"+n]=m;i[n.toLowerCase()]=m;z+=(z?"|":"")+n}tinymce.each(a.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mp3,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar").split(";"),function(d){var b,f,j;d=d.split(/=/);f=tinymce.explode(d[1].toLowerCase());
for(b=0;b<f.length;b++)if(j=i[d[0].toLowerCase()])i[f[b]]=j});z=RegExp("write("+z+")\\(([^)]+)\\)");e.lookup=i;a.onPreInit.add(function(){a.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]");a.parser.addNodeFilter("object,embed,video,audio,script",function(d){for(var b=d.length;b--;)e.objectToImg(d[b])});a.serializer.addNodeFilter("img",function(d,b,f){b=d.length;for(var j;b--;){j=d[b];if((j.attr("class")||
"").indexOf("mceItemMedia")!==-1)e.imgToObject(j,f)}})});a.settings.content_css!==false&&a.contentCSS.push(g+"/css/content.css");a.onInit.add(function(){a.theme&&a.theme.onResolveName&&a.theme.onResolveName.add(function(d,b){if(b.name==="img"&&a.dom.hasClass(b.node,"mceItemMedia"))b.name="media"});a&&a.plugins.contextmenu&&a.plugins.contextmenu.onContextMenu.add(function(d,b,f){f.nodeName==="IMG"&&f.className.indexOf("mceItemMedia")!==-1&&b.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})});
a.addCommand("mceMedia",function(){var d,b;b=a.selection.getNode();if(c(b)){d=w.parse(a.dom.getAttrib(b,"data-mce-json"));tinymce.each("id,width,height,class".split(","),function(f){var j=a.dom.getAttrib(b,f);if(j)d[f]=j});d.type=e.getType(b.className).name.toLowerCase()}d||(d={type:"flash",video:{sources:[]},params:{}});a.windowManager.open({file:g+"/media.htm",width:430+parseInt(a.getLang("media.delta_width",0)),height:500+parseInt(a.getLang("media.delta_height",0)),inline:1},{plugin_url:g,data:d})});
a.addButton("media",{title:"media.desc",cmd:"mceMedia"});a.onNodeChange.add(function(d,b,f){b.setActive("media",c(f))})},convertUrl:function(a,g){var c=this.editor,e=c.settings,i=e.url_converter;e=e.url_converter_scope||this;if(!a)return a;if(g)return c.documentBaseURI.toAbsolute(a);return i.call(e,a,"src","object")},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",
version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(a,g){var c,e;a.params.src=this.convertUrl(a.params.src,g);if(c=a.video.attrs)c.src=this.convertUrl(c.src,g);if(c)c.poster=this.convertUrl(c.poster,g);if(c=B(a.video.sources))for(e=0;e<c.length;e++)c[e].src=this.convertUrl(c[e].src,g);c=this.editor.dom.create("img",{id:a.id,style:a.style,src:this.url+"/img/trans.gif","class":"mceItemMedia mceItem"+this.getType(a.type).name,"data-mce-json":w.serialize(a,"'")});c.width=a.width||
"320";c.height=a.height||"240";return c},dataToHtml:function(a,g){return this.editor.serializer.serialize(this.dataToImg(a,g),{force_absolute:g})},htmlToData:function(a){var g,c;c={type:"flash",video:{sources:[]},params:{}};if(g=this.editor.parser.parse(a).getAll("img")[0]){c=w.parse(g.attr("data-mce-json"));c.type=this.getType(g.attr("class")).name.toLowerCase();tinymce.each("id,width,height,class".split(","),function(e){var i=g.attr(e);if(i)c[e]=i})}return c},getType:function(a){var g,c;g=tinymce.explode(a,
" ");for(a=0;a<g.length;a++)if(c=this.lookup[g[a]])return c},imgToObject:function(a,g){function c(o,u){var r,x;r=i.documentBaseURI;b.params.src=i.getParam("flash_video_player_url",e.convertUrl(e.url+"/img/moxieplayer.swf"));if(i.getParam("flash_video_player_absvideourl",true)){o=r.toAbsolute(o||"",true);u=r.toAbsolute(u||"",true)}x="";r=i.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"});tinymce.each(r,function(v,A){v=v.replace(/\$url/,o||"");v=v.replace(/\$poster/,u||"");if(v.length>
0)x+=(x?"&":"")+A+"="+escape(v)});if(x.length)b.params.flashvars=x;r=i.getParam("flash_video_player_params",{allowfullscreen:true,allowscriptaccess:true});tinymce.each(r,function(v,A){b.params[A]=""+v})}var e=this,i=e.editor,l,h,m,n,d,b,f,j,p,k,t,q;b=w.parse(a.attr("data-mce-json"));j=this.getType(a.attr("class"));q=a.attr("data-mce-style");if(!q)if(q=a.attr("style"))q=i.dom.serializeStyle(i.dom.parseStyle(q,"img"));if(this.editor.settings.media_use_script){replacement=(new s("script",1)).attr("type",
"text/javascript");d=new s("#text",3);d.value="write"+j.name+"("+w.serialize(tinymce.extend(b.params,{width:a.attr("width"),height:a.attr("height")}))+");";replacement.append(d);a.replace(replacement)}else{if(j.name==="Video"&&b.video.sources[0]){l=(new s("video",1)).attr(tinymce.extend({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:q},b.video.attrs));if(b.video.attrs)t=b.video.attrs.poster;f=b.video.sources=B(b.video.sources);for(p=0;p<f.length;p++)if(/\.mp4$/.test(f[p].src))k=
f[p].src;if(!f[0].type){l.attr("src",f[0].src);f.splice(0,1)}for(p=0;p<f.length;p++){d=(new s("source",1)).attr(f[p]);d.shortEnded=true;l.append(d)}if(k){c(k,t);j=e.getType("flash")}else b.params.src=""}if(b.params.src){/\.flv$/i.test(b.params.src)&&c(b.params.src,"");if(g&&g.force_absolute)b.params.src=i.documentBaseURI.toAbsolute(b.params.src);h=(new s("object",1)).attr({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:q});tinymce.each(tinymce.explode("name,bgcolor,align,vspace,hspace"),
function(o){b[o]&&h.attr(o,b[o])});for(n in b.params){f=new s("param",1);f.shortEnded=true;d=b.params[n];if(n==="src"&&j.name==="WindowsMedia")n="url";f.attr({name:n,value:d});h.append(f)}if(this.editor.getParam("media_strict",true))h.attr({data:b.params.src,type:j.mimes[0]});else{h.attr({classid:"clsid:"+j.clsids[0],codebase:j.codebase});m=new s("embed",1);m.shortEnded=true;m.attr({id:a.attr("id"),width:a.attr("width"),height:a.attr("height"),style:q,type:j.mimes[0]});for(n in b.params)m.attr(n,
b.params[n]);tinymce.each(tinymce.explode("name,bgcolor,align,vspace,hspace"),function(o){b[o]&&m.attr(o,b[o])});h.append(m)}if(b.object_html){d=new s("#text",3);d.raw=true;d.value=b.object_html;h.append(d)}l&&l.append(h)}if(l)if(b.video_html){d=new s("#text",3);d.raw=true;d.value=b.video_html;l.append(d)}l||h?a.replace(l||h):a.remove()}},objectToImg:function(a){function g(x){return(new tinymce.html.Serializer({inner:true,validate:false})).serialize(x)}var c,e,i,l,h,m,n,d,b,f,j,p,k,t,q=this.lookup,
o,u=this.editor.settings.url_converter,r=this.editor.settings.url_converter_scope;if(a.parent){if(a.name==="script"){if(a.firstChild)l=z.exec(a.firstChild.value);if(!l)return;t=l[1];k={video:{},params:w.parse(l[2])};n=k.params.width;d=k.params.height}k=k||{video:{},params:{}};l=new s("img",1);l.attr({src:this.url+"/img/trans.gif"});h=a.name;if(h==="video"){i=a;c=a.getAll("object")[0];e=a.getAll("embed")[0];n=i.attr("width");d=i.attr("height");m=i.attr("id");k.video={attrs:{},sources:[]};o=k.video.attrs;
for(h in i.attributes.map)o[h]=i.attributes.map[h];(j=a.attr("src"))&&k.video.sources.push({src:u.call(r,j,"src","video")});p=i.getAll("source");for(f=0;f<p.length;f++){j=p[f].remove();k.video.sources.push({src:u.call(r,j.attr("src"),"src","source"),type:j.attr("type"),media:j.attr("media")})}if(o.poster)o.poster=u.call(r,o.poster,"poster","video")}if(a.name==="object"){c=a;e=a.getAll("embed")[0]}if(a.name==="embed")e=a;if(c){n=n||c.attr("width");d=d||c.attr("height");b=b||c.attr("style");m=m||c.attr("id");
p=c.getAll("param");for(f=0;f<p.length;f++){j=p[f];h=j.remove().attr("name");C[h]||(k.params[h]=j.attr("value"))}k.params.src=k.params.src||c.attr("data")}if(e){n=n||e.attr("width");d=d||e.attr("height");b=b||e.attr("style");m=m||e.attr("id");for(h in e.attributes.map)if(!C[h]&&!k.params[h])k.params[h]=e.attributes.map[h]}if(k.params.movie){k.params.src=k.params.src||k.params.movie;delete k.params.movie}if(k.params.src)k.params.src=u.call(r,k.params.src,"src","object");if(i)t=q.video.name;if(c&&!t)t=
(q[(c.attr("clsid")||"").toLowerCase()]||q[(c.attr("type")||"").toLowerCase()]||{}).name;if(e&&!t)t=(q[(e.attr("type")||"").toLowerCase()]||{}).name;a.replace(l);e&&e.remove();if(c)if(a=g(c.remove()))k.object_html=a;if(i)if(a=g(i.remove()))k.video_html=a;l.attr({id:m,"class":"mceItemMedia mceItem"+(t||"Flash"),style:b,width:n||"320",height:d||"240","data-mce-json":w.serialize(k,"'")})}}});tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();
